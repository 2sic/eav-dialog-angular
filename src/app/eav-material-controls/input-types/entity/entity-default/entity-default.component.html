<div *ngIf="!freeTextMode && (enableCreate || (chosenEntities && chosenEntities.length > 0))">
  <div class="dnd-placeholder" #placeholder>
  </div>
  <div [dndList]="dndListConfig" [dndPlaceholder]="placeholder" [dndModel]="chosenEntities">
    <div *ngFor="let item of chosenEntities; let i = index" [dndType]="item.type" [dndDraggable] [dndObject]="item"
      (dndMoved)="removeItem(item, chosenEntities)">
      <div [ngClass]="allowMultiValue ? 'dnd-element-multi mat-elevation-z2' : 'dnd-element'" fxLayout="row"
        fxLayoutAlign="start center">
        <!-- <i title="" class="eav-icon-link pull-left eav-entityselect-icon" *ngIf="allowMultiValue"></i>
        <i title="" class="eav-icon-link pull-left eav-entityselect-icon" *ngIf="!allowMultiValue"></i> -->
        <div class="dnd-element-content">
          <div *ngIf="!allowMultiValue">
            <mat-label class="mat-caption">{{config.label}} {{config.required ? '*': '' }}</mat-label>
          </div>
          <div fxLayout="row" fxLayoutAlign="start center">
            <mat-icon>link</mat-icon>
            <span>&nbsp;&nbsp;</span>
            <span class="dnd-element-text" [title]="getEntityText(item.name) + ' (' + item.name + ')'">{{getEntityText(item.name)}}</span>
          </div>
        </div>
        <!-- dndHandle -->
        <div class="dnd-buttons" fxLayoutAlign="end center">
          <button dndNoDrag mat-icon-button *ngIf="enableEdit" type="button" class="dndButtons" (click)="edit(item.name)"
            title="{{ 'FieldType.Entity.Edit' | translate }}" [disabled]="disabled">
            <mat-icon>edit</mat-icon>
          </button>
          <button dndNoDrag mat-icon-button *ngIf="enableRemove" type="button" class="dndButtons" (click)="removeSlot(item.name, i)"
            title="{{ 'FieldType.Entity.Remove' | translate }}" [disabled]="disabled">
            <mat-icon> {{allowMultiValue ? 'remove_circle' : 'arrow_drop_down'}}</mat-icon>
          </button>
          <button dndNoDrag mat-icon-button *ngIf="enableDelete" type="button" class="dndButtons" (click)="deleteItemInSlot(item.name)"
            title="{{ 'General.Buttons.Delete' | translate }}" [disabled]="disabled">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="allowMultiValue" class="dnd-space"></div>
</div>

<!-- pick existing entity close-->
<div [hidden]="freeTextMode">
  <div class="ed-field" fxLayout="row" fxLayoutAlign="start start">
    <div [ngClass]="(enableCreate && entityType !== '' && chosenEntities.length < 1 && !allowMultiValue) ? 'ed-field__field-short' : 'ed-field__field'">
      <div [hidden]="!(enableAddExisting && (allowMultiValue || (chosenEntities && chosenEntities.length < 1)))">
        <mat-form-field [formGroup]="group" appearance="fill" color="accent">
          <!--(click)="setSelectEntitiesObservables()"  -->
          <input matInput type="text" #autocompleteInput placeholder="search" [matAutocomplete]="auto" [disabled]="disabled"
            [required]="config.required">
          <mat-icon matSuffix *ngIf="!enableTextEntry">arrow_drop_down</mat-icon>
          <!-- <mat-hint align="start" *ngIf="config.settings.Notes">{{config.settings.Notes}}</mat-hint> -->
          <a matSuffix *ngIf="enableTextEntry" (click)="freeTextModeChange($event)">
            <i class="eav-icon-i-cursor"></i>
            <mat-icon *ngIf="freeTextMode">arrow_drop_down</mat-icon>
          </a>
          <mat-label>{{ allowMultiValue ? ('FieldType.Entity.Choose' | translate) : config.label}}</mat-label>
        </mat-form-field>
        <mat-error *ngIf="inputInvalid">{{ getErrorMessage() | translate:{ param: config.settings } }}</mat-error>

        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="optionSelected($event)">
          <mat-option *ngFor="let item of (selectEntities | async)" [value]="item.Value" [disabled]="isInChosenEntities(item.Value)">
            <span>{{item.Text ? item.Text: item.Value}} {{value}}</span>
          </mat-option>
        </mat-autocomplete>
        <!-- <span ng-if="!error">{{ 'FieldType.EntityQuery.QueryNoItems' | translate }}</span> -->
      </div>
    </div>
    <div [ngClass]="(enableCreate && entityType !== '' && chosenEntities.length < 1 && !allowMultiValue) ? 'ed-field__create-icon' : 'ed-field__create-icon-hide'"
      fxLayoutAlign="end center">
      <!-- create new entity to add to this list -->
      <button mat-icon-button *ngIf="enableCreate && entityType !== '' && chosenEntities.length < 1 && !allowMultiValue"
        type="button" (click)="openNewEntityDialog()" [disabled]="disabled">
        <mat-icon>add</mat-icon>
      </button>
    </div>
  </div>
</div>

<!-- formly-skip-ng-model-attrs-manipulator -->
<mat-form-field *ngIf="freeTextMode" [formGroup]="group" appearance="fill" color="accent">
  <!-- [formControlName]="config.name" -->
  <input matInput type="text" [required]='config.required' [id]="id" [formControlName]="config.name" [placeholder]="config.placeholder">
  <!-- *ngIf="enableTextEntry  && (allowMultiValue || chosenEntities.length < 1)"  -->
  <a matSuffix (click)="freeTextModeChange($event)">
    <i *ngIf="!freeTextMode" class="eav-icon-i-cursor"></i>
    <mat-icon *ngIf="freeTextMode">arrow_drop_down</mat-icon>
  </a>
  <mat-label>{{config.label}}</mat-label>
</mat-form-field>

<app-field-helper-text [config]="config" [group]="group"></app-field-helper-text>

<div *ngIf="!freeTextMode && enableCreate && entityType !== '' && allowMultiValue">
  <button mat-mini-fab color="accent" type="button" (click)="openNewEntityDialog()" [disabled]="disabled">
    <mat-icon>add</mat-icon>
  </button>
</div>